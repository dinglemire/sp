name: Update Page Index

on:
  # Keep this if you still want to run it manually sometimes
  workflow_dispatch:
  
  # This makes it run automatically
  push:
    paths:
      - 'saved_pages/**.html'  # Only runs when HTML files in this folder change

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Generate File List
        run: |
          echo "[" > pages.json
          first=true
          # Find html files, sort them to keep order consistent
          find saved_pages -name "*.html" -print0 | sort -z | while IFS= read -r -d '' file; do
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> pages.json
            fi
            filename=$(basename "$file")
            # Create JSON entry
            echo "  { \"path\": \"$file\", \"name\": \"$filename\" }" >> pages.json
          done
          echo "]" >> pages.json

      - name: Commit and Push if changed
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add pages.json
          # The commit message includes [skip ci] to be double-safe against loops
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update pages.json [skip ci]" && git push)
