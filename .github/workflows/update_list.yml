name: Update Page Index

on:
  workflow_dispatch:
  push:
    paths:
      - 'saved_pages/**.html'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # <--- CRITICAL: This allows us to check the history (dates)

      - name: Generate File List
        run: |
          echo "[" > pages.json
          first=true
          
          # Find html files
          find saved_pages -name "*.html" -print0 | while IFS= read -r -d '' file; do
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> pages.json
            fi
            
            filename=$(basename "$file")
            
            # GET THE REAL UPLOAD DATE FROM GIT HISTORY
            # %ai = Author date, ISO 8601 format
            filedate=$(git log -1 --format="%ai" -- "$file")
            
            # Fallback if file is brand new and not in history yet
            if [ -z "$filedate" ]; then
                filedate=$(date '+%Y-%m-%d %H:%M:%S')
            fi

            # Save to JSON
            echo "  { \"path\": \"$file\", \"name\": \"$filename\", \"date\": \"$filedate\" }" >> pages.json
          done
          echo "]" >> pages.json

      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add pages.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update index with real git dates [skip ci]" && git push)
