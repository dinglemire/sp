name: Update Page Index

on:
  workflow_dispatch: # Allows manual trigger
  push:
    paths:
      - 'saved_pages/**.html' # Triggers only when HTML files in this folder change

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # <--- IMPORTANT: Required to get file history/dates

      - name: Generate File List
        run: |
          echo "[" > pages.json
          first=true
          
          # Find all HTML files in saved_pages
          find saved_pages -name "*.html" -print0 | while IFS= read -r -d '' file; do
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> pages.json
            fi
            
            filename=$(basename "$file")
            
            # Get the last commit date for this file (Format: YYYY-MM-DD HH:MM:SS)
            filedate=$(git log -1 --format="%ai" -- "$file")
            
            # If file is new and has no git history yet, use current time
            if [ -z "$filedate" ]; then
                filedate=$(date '+%Y-%m-%d %H:%M:%S')
            fi

            # Append to JSON: path, name, date
            echo "  { \"path\": \"$file\", \"name\": \"$filename\", \"date\": \"$filedate\" }" >> pages.json
          done
          echo "]" >> pages.json

      - name: Commit and Push if changed
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add pages.json
          # Check for changes and commit. [skip ci] prevents infinite loops.
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update index with dates [skip ci]" && git push)
