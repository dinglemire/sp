<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Archive</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <h1>ðŸ“š Personal Web Archive</h1>
    
    <div class="controls">
        <input type="text" id="search" placeholder="ðŸ” Search pages..." onkeyup="filterPages()">
        
        <select id="sortSelect" onchange="sortAndRender()">
            <option value="newest">ðŸ“… Uploaded: Newest</option>
            <option value="oldest">ðŸ“… Uploaded: Oldest</option>
            <option value="az">ðŸ”¤ Name (A-Z)</option>
        </select>
    </div>

    <div id="gallery" class="grid">
        <div class="loading">Loading library...</div>
    </div>

    <script>
        let allPages = [];

        async function loadPages() {
            try {
                // Fetch JSON with timestamp to avoid caching
                const response = await fetch('pages.json?t=' + new Date().getTime());
                if (!response.ok) throw new Error("JSON not found");
                
                allPages = await response.json();
                
                // Initial Sort
                sortAndRender();
            } catch (error) {
                document.getElementById('gallery').innerHTML = 
                    `<div class="error">Failed to load database.</div>`;
            }
        }

        function sortAndRender() {
            const sortMode = document.getElementById('sortSelect').value;

            allPages.sort((a, b) => {
                // Parse the Git date strings
                const dateA = new Date(a.date || 0);
                const dateB = new Date(b.date || 0);

                if (sortMode === 'oldest') {
                    return dateA - dateB;
                } else if (sortMode === 'az') {
                    return a.name.localeCompare(b.name);
                } else {
                    // Default: Newest First
                    return dateB - dateA;
                }
            });

            filterPages();
        }

        function render(items) {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';

            if (items.length === 0) {
                gallery.innerHTML = '<div class="loading">No pages found.</div>';
                return;
            }

            items.forEach(item => {
                // Clean up name for display (remove .html)
                const displayName = item.name.replace('.html', '');
                
                // Format the Git Date
                let dateStr = "Unknown";
                if (item.date) {
                    const dateObj = new Date(item.date);
                    if (!isNaN(dateObj)) {
                        dateStr = dateObj.toLocaleDateString('en-GB', { 
                            year: 'numeric', month: 'short', day: 'numeric' 
                        });
                    }
                }

                const link = document.createElement('a');
                link.className = 'card';
                link.href = item.path;
                link.target = "_blank";
                
                link.innerHTML = `
                    <div class="filename">${displayName}</div>
                    <div class="meta">
                        <span class="date-badge">ðŸ“… ${dateStr}</span>
                        <span class="tag">HTML</span>
                    </div>
                `;
                gallery.appendChild(link);
            });
        }

        function filterPages() {
            const query = document.getElementById('search').value.toLowerCase();
            const filtered = allPages.filter(p => p.name.toLowerCase().includes(query));
            render(filtered);
        }

        loadPages();
    </script>
</body>
</html>
